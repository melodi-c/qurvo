# @qurvo/sdk-tma

Telegram Mini Apps SDK for Qurvo analytics. Wraps `@qurvo/sdk-core`.

## Commands

```bash
pnpm --filter @qurvo/sdk-tma build   # tsc + IIFE bundle → dist/
pnpm --filter @qurvo/sdk-tma dev     # tsc --watch
```

## Usage

```typescript
import { qurvo } from '@qurvo/sdk-tma';

Telegram.WebApp.ready();
qurvo.init({ apiKey: 'sk_...', endpoint: 'https://ingest.example.com' });

qurvo.track('item_viewed', { item_id: '42' });
qurvo.identify('your-internal-user-id'); // optional — Telegram user ID is already distinct_id
```

## API

| Method | Description |
|---|---|
| `init(config)` | Initialize SDK, tracks `tma_opened`, starts queue flush timer |
| `track(event, properties?)` | Track custom event |
| `identify(userId, userProperties?)` | Link Telegram user ID to internal user ID (sends `$identify`) |
| `set(properties)` | Set user properties |
| `setOnce(properties)` | Set user properties (only if not already set) |
| `reset()` | Clear identity, stop queue (call `init()` again to restart) |

## TMA-Specific Features

- **distinct_id**: `Telegram.WebApp.initDataUnsafe.user.id` (numeric, stringified). Falls back to a random UUID if not in TMA context.
- **Session ID**: UUID stored in `sessionStorage` (same as sdk-browser)
- **CloudStorage queue**: Events persisted to `Telegram.WebApp.CloudStorage` under key `qurvo_queue`. Restored on next init. Falls back to in-memory queue if CloudStorage is unavailable.
- **Auto-event `tma_opened`**: Fired on init with platform, start_param, Telegram user metadata.
- **Flush on viewportChanged**: Fires `flushForUnload()` when TMA viewport changes (collapse/close).
- **Flush on visibilitychange**: Fallback beacon flush when tab/webview hides.
- **Optional auto-events**: `main_button_clicked`, `back_button_pressed`, `invoice_closed` (configured via `autoEvents` in `TmaSdkConfig`)

## Config — TmaSdkConfig

- `apiKey` (required)
- `endpoint` (optional) — ingest API URL, default `http://localhost:3001`
- `distinctId` (optional) — override automatic Telegram user ID resolution
- `autoEvents.mainButton` (optional) — auto-track `main_button_clicked`
- `autoEvents.backButton` (optional) — auto-track `back_button_pressed`
- `autoEvents.invoiceClosed` (optional) — auto-track `invoice_closed` with `{ url, status }`
- `flushInterval` (optional, default `3000`) — ms between auto-flushes
- `flushSize` (optional, default `10`) — events per batch

## Types

- `TelegramUser` — `{ id, username?, first_name, last_name?, is_premium?, language_code?, photo_url? }`
- `TmaSdkConfig` — SDK configuration
- `TelegramWebApp`, `TelegramCloudStorage`, etc. — internal Telegram WebApp typings (in `telegram.d.ts`)

## Structure

```
src/
├── index.ts      # QurvoTma class + singleton `qurvo` export
├── cdn.ts        # IIFE entry point (exposes window.QurvoTma)
├── version.ts    # SDK_VERSION constant (auto-generated by prebuild)
└── telegram.d.ts # Minimal Telegram WebApp type declarations
```

## Build outputs

```
dist/
├── index.js            # CommonJS (main entry)
├── index.d.ts          # TypeScript declarations
├── qurvo-tma.iife.js   # Minified IIFE bundle for CDN use
└── qurvo-tma.iife.js.map
```

## CloudStorage gotchas

- `CloudStorage.getItem` is async/callback — the SDK kicks off a load at init and re-queues events via callback. There is a short window (< 1 event cycle) where restored events may arrive after the first `tma_opened` event.
- CloudStorage values are limited to 1024 bytes in the Telegram client — very large queues may be silently truncated. The SDK caps queue size at 1000 events with LRU eviction to mitigate this.
- `CloudStorage` is only available in the Telegram WebApp context. Running in a desktop browser for development will fall back to in-memory queue.
